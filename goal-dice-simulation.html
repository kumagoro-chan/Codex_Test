<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Goal サイコロゲーム・シミュレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(6px);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 320px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 360px;
            }
        }

        table th, table td {
            white-space: nowrap;
        }

        table thead {
            position: sticky;
            top: 0;
            background-color: #1d4ed8;
            color: #fff;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <header class="bg-blue-900 text-white py-10 shadow-lg">
            <div class="max-w-5xl mx-auto px-4">
                <p class="uppercase tracking-widest text-sm text-blue-200 mb-2">TOC体験学習</p>
                <h1 class="text-3xl md:text-5xl font-bold mb-3">The Goal サイコロゲーム・シミュレーター</h1>
                <p class="text-base md:text-lg text-blue-100 leading-relaxed">
                    ゴールドラット博士の小説『The Goal』に登場する「カウボーイの遠足」のサイコロゲームをブラウザ上で再現。
                    不確実性、バラツキ、バッファの意味をデジタルで体感できます。
                </p>
            </div>
        </header>

        <main class="max-w-5xl mx-auto px-4 -mt-10 pb-16">
            <section class="card rounded-2xl shadow-xl p-6 md:p-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-blue-900 mb-6">シミュレーション条件</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <label class="block">
                        <span class="text-sm font-semibold text-slate-600">工程数 (ステーション)</span>
                        <input id="stations" type="number" min="2" max="8" value="5" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold text-slate-600">シミュレーション日数</span>
                        <input id="days" type="number" min="5" max="60" value="20" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold text-slate-600">サイコロの面数</span>
                        <input id="dieSides" type="number" min="2" max="12" value="6" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold text-slate-600">初期バッファ (各工程の手前にある仕掛かり数)</span>
                        <input id="initialBuffer" type="number" min="0" max="20" value="2" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold text-slate-600">原材料在庫 (工程1の前にある数量)</span>
                        <input id="rawStock" type="number" min="10" max="500" value="120" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <label class="block">
                        <span class="text-sm font-semibold text-slate-600">需要目標 (累計出荷の目標値)</span>
                        <input id="target" type="number" min="10" max="500" value="100" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                    <label class="block md:col-span-2">
                        <span class="text-sm font-semibold text-slate-600">乱数シード (任意、同じ結果を再現したいときに入力)</span>
                        <input id="seed" type="text" placeholder="例: toc-lab" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </label>
                </div>
                <button id="runSimulation" class="mt-8 w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 rounded-xl transition shadow-lg shadow-blue-200/60 flex items-center gap-2">
                    <span>シミュレーションを実行</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0112.864-5.303l.636.636m0 0V4.5m0 2.833h-2.833M19.5 12a7.5 7.5 0 01-12.864 5.303l-.636-.636m0 0V19.5m0-2.833h2.833" />
                    </svg>
                </button>
            </section>

            <section id="resultsSection" class="mt-12 hidden space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-sm text-slate-500 font-semibold">累計出荷量</p>
                        <p id="totalShipment" class="text-3xl font-bold text-blue-700 mt-2">-</p>
                        <p id="avgThroughput" class="text-xs text-slate-500 mt-2">平均日次スループット: -</p>
                        <p id="targetStatus" class="text-xs text-slate-500 mt-2">-</p>
                    </div>
                    <div class="card rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-sm text-slate-500 font-semibold">最終仕掛かり (WIP)</p>
                        <p id="finalWip" class="text-3xl font-bold text-emerald-600 mt-2">-</p>
                        <p id="wipMessage" class="text-xs text-slate-500 mt-2">-</p>
                    </div>
                    <div class="card rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-sm text-slate-500 font-semibold">原材料残</p>
                        <p id="rawRemaining" class="text-3xl font-bold text-amber-500 mt-2">-</p>
                        <p class="text-xs text-slate-500 mt-2">原材料が尽きるとラインは停止します</p>
                    </div>
                    <div class="card rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-sm text-slate-500 font-semibold">ボトルネック推定</p>
                        <p id="bottleneck" class="text-xl font-semibold text-rose-600 mt-2">-</p>
                        <p class="text-xs text-slate-500 mt-2">最も平均処理量の低い工程</p>
                    </div>
                </div>

                <div class="card rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">累計出荷と需要目標</h3>
                    <div class="chart-container">
                        <canvas id="shipmentChart"></canvas>
                    </div>
                </div>

                <div class="card rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">日次スループットと総WIP</h3>
                    <div class="chart-container">
                        <canvas id="throughputChart"></canvas>
                    </div>
                </div>

                <div class="card rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">工程別の処理量サマリー</h3>
                    <div class="overflow-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="px-3 py-2 text-left">工程</th>
                                    <th class="px-3 py-2 text-left">平均処理量</th>
                                    <th class="px-3 py-2 text-left">最大処理量</th>
                                    <th class="px-3 py-2 text-left">最小処理量</th>
                                </tr>
                            </thead>
                            <tbody id="stationSummaryBody" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                        <h3 class="text-xl font-bold text-blue-900">日次の工程ロールとWIP推移</h3>
                        <button id="downloadCsv" class="w-full md:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-50 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5v-12m0 12L8.25 12m3.75 4.5L15.75 12M3 20.25h18" />
                            </svg>
                            CSVでダウンロード
                        </button>
                    </div>
                    <div class="overflow-auto max-h-[420px] border border-slate-200 rounded-xl">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="px-3 py-2 text-left">日</th>
                                    <th class="px-3 py-2 text-left">出荷</th>
                                    <th class="px-3 py-2 text-left">累計出荷</th>
                                    <th class="px-3 py-2 text-left">総WIP</th>
                                    <th class="px-3 py-2 text-left">原材料残</th>
                                    <th class="px-3 py-2 text-left">各工程ロール</th>
                                    <th class="px-3 py-2 text-left">各工程処理量</th>
                                </tr>
                            </thead>
                            <tbody id="logBody" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">ゲームの学びのポイント</h3>
                    <ul class="list-disc list-inside space-y-2 text-sm leading-relaxed text-slate-600">
                        <li>平均値ではなくバラツキが全体のスループットを支配します。サイコロの振れ幅が工程間のギャップを生みます。</li>
                        <li>仕掛かり (WIP) はボトルネックの前で蓄積し、後工程では不足が発生することで全体の流れが揺さぶられます。</li>
                        <li>制約工程 (ボトルネック) の能力が実質的なペースメーカーとなり、そこを守るバッファ管理が鍵となります。</li>
                        <li>需要目標に対して十分なスループットを確保するには、制約の能力強化やバラツキの低減が必要です。</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <script>
        function xfnv1a(str) {
            let h = 2166136261 >>> 0;
            for (let i = 0; i < str.length; i++) {
                h ^= str.charCodeAt(i);
                h = Math.imul(h, 16777619);
            }
            return h >>> 0;
        }

        function mulberry32(a) {
            return function () {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            };
        }

        function createRng(seedText) {
            if (!seedText || !seedText.trim()) {
                return Math.random;
            }
            const hashed = xfnv1a(seedText.trim());
            return mulberry32(hashed);
        }

        function rollDie(rng, sides) {
            return Math.floor(rng() * sides) + 1;
        }

        function simulate({ stations, days, dieSides, initialBuffer, rawStock, target, seed }) {
            const rng = createRng(seed);
            const buffers = Array(stations).fill(0);
            for (let i = 1; i < stations; i++) {
                buffers[i] = initialBuffer;
            }

            let raw = rawStock;
            let cumulativeShipment = 0;
            const dailyLog = [];
            const stationHistory = Array.from({ length: stations }, () => []);
            const stationMax = Array(stations).fill(0);
            const stationMin = Array(stations).fill(Infinity);
            const shipmentHistory = [];
            const wipHistory = [];

            for (let day = 1; day <= days; day++) {
                const rolls = [];
                const processed = [];
                let shipmentToday = 0;

                for (let s = 0; s < stations; s++) {
                    const roll = rollDie(rng, dieSides);
                    rolls.push(roll);

                    let available;
                    if (s === 0) {
                        available = Math.min(roll, raw);
                        raw -= available;
                    } else {
                        available = Math.min(roll, buffers[s]);
                        buffers[s] -= available;
                    }

                    processed.push(available);
                    stationHistory[s].push(available);
                    stationMax[s] = Math.max(stationMax[s], available);
                    stationMin[s] = Math.min(stationMin[s], available);

                    if (s < stations - 1) {
                        buffers[s + 1] += available;
                    } else {
                        shipmentToday += available;
                        cumulativeShipment += available;
                    }
                }

                const totalWip = buffers.slice(1).reduce((sum, v) => sum + v, 0);
                shipmentHistory.push(shipmentToday);
                wipHistory.push(totalWip);

                dailyLog.push({
                    day,
                    rolls,
                    processed,
                    shipmentToday,
                    cumulativeShipment,
                    totalWip,
                    raw
                });

                if (raw <= 0 && shipmentToday === 0) {
                    break; // ライン停止
                }
            }

            const avgThroughput = cumulativeShipment / dailyLog.length;
            const finalWip = dailyLog.length ? dailyLog[dailyLog.length - 1].totalWip : 0;
            const rawRemaining = dailyLog.length ? dailyLog[dailyLog.length - 1].raw : rawStock;

            let bottleneckIndex = 0;
            let minAvg = Infinity;
            stationHistory.forEach((history, index) => {
                const avg = history.length ? history.reduce((sum, value) => sum + value, 0) / history.length : Infinity;
                if (avg < minAvg) {
                    minAvg = avg;
                    bottleneckIndex = index;
                }
            });

            return {
                dailyLog,
                cumulativeShipment,
                avgThroughput,
                finalWip,
                rawRemaining,
                bottleneckIndex,
                target,
                stationHistory,
                stationMax,
                stationMin,
                shipmentHistory,
                wipHistory
            };
        }

        let shipmentChart;
        let throughputChart;

        function renderResults(result, stations) {
            const {
                dailyLog,
                cumulativeShipment,
                avgThroughput,
                finalWip,
                rawRemaining,
                bottleneckIndex,
                target,
                stationHistory,
                stationMax,
                stationMin,
                shipmentHistory,
                wipHistory
            } = result;

            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('totalShipment').textContent = `${cumulativeShipment.toLocaleString()} 個`;
            document.getElementById('avgThroughput').textContent = `平均日次スループット: ${avgThroughput.toFixed(2)} 個/日`;
            document.getElementById('finalWip').textContent = `${finalWip.toLocaleString()} 個`;
            document.getElementById('wipMessage').textContent = finalWip > 0
                ? '仕掛かりはボトルネック手前で蓄積しています'
                : '仕掛かりはすべて消化されました';
            document.getElementById('rawRemaining').textContent = `${rawRemaining.toLocaleString()} 個`;
            document.getElementById('targetStatus').textContent = cumulativeShipment >= target
                ? `需要目標を達成しました (目標 ${target.toLocaleString()} 個)`
                : `需要目標まで残り ${(target - cumulativeShipment).toLocaleString()} 個`;
            const bottleneckAvg = result.dailyLog.length
                ? (result.dailyLog.reduce((sum, log) => sum + log.processed[bottleneckIndex], 0) / result.dailyLog.length).toFixed(2)
                : '0.00';
            document.getElementById('bottleneck').textContent = `工程 ${bottleneckIndex + 1} (平均 ${bottleneckAvg} 個/日)`;

            const labels = dailyLog.map(log => `Day ${log.day}`);
            const cumulativeData = dailyLog.map(log => log.cumulativeShipment);
            const targetLine = dailyLog.map(() => target);
            const shipments = shipmentHistory;
            const wipData = wipHistory;

            if (shipmentChart) {
                shipmentChart.destroy();
            }

            shipmentChart = new Chart(document.getElementById('shipmentChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: '累計出荷',
                            data: cumulativeData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.15)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4
                        },
                        {
                            label: '需要目標',
                            data: targetLine,
                            borderColor: '#f97316',
                            borderDash: [6, 6],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                font: { family: 'Noto Sans JP' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.parsed.y.toLocaleString()} 個`
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: { family: 'Noto Sans JP' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: { family: 'Noto Sans JP' }
                            }
                        }
                    }
                }
            });

            if (throughputChart) {
                throughputChart.destroy();
            }

            throughputChart = new Chart(document.getElementById('throughputChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: '日次出荷',
                            data: shipments,
                            backgroundColor: 'rgba(22, 163, 74, 0.55)',
                            borderColor: '#16a34a',
                            borderWidth: 1,
                            order: 1
                        },
                        {
                            type: 'line',
                            label: '総WIP',
                            data: wipData,
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.2)',
                            tension: 0.25,
                            fill: false,
                            yAxisID: 'y1',
                            pointRadius: 4,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '日次出荷量', font: { family: 'Noto Sans JP' } },
                            ticks: { font: { family: 'Noto Sans JP' } }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: '総WIP', font: { family: 'Noto Sans JP' } },
                            ticks: { font: { family: 'Noto Sans JP' } }
                        },
                        x: {
                            ticks: { font: { family: 'Noto Sans JP' } }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { font: { family: 'Noto Sans JP' } }
                        }
                    }
                }
            });

            const logBody = document.getElementById('logBody');
            logBody.innerHTML = '';

            dailyLog.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';

                const rollsText = log.rolls.map((roll, idx) => `工程${idx + 1}: ${roll}`).join(' / ');
                const processedText = log.processed.map((qty, idx) => `工程${idx + 1}: ${qty}`).join(' / ');

                row.innerHTML = `
                    <td class="px-3 py-2 font-semibold text-slate-700">${log.day}</td>
                    <td class="px-3 py-2">${log.shipmentToday}</td>
                    <td class="px-3 py-2">${log.cumulativeShipment}</td>
                    <td class="px-3 py-2">${log.totalWip}</td>
                    <td class="px-3 py-2">${log.raw}</td>
                    <td class="px-3 py-2 text-slate-500">${rollsText}</td>
                    <td class="px-3 py-2 text-slate-500">${processedText}</td>
                `;

                logBody.appendChild(row);
            });

            const stationSummaryBody = document.getElementById('stationSummaryBody');
            stationSummaryBody.innerHTML = '';

            stationHistory.forEach((history, index) => {
                const avg = history.length ? (history.reduce((sum, value) => sum + value, 0) / history.length) : 0;
                const max = history.length ? stationMax[index] : 0;
                const min = history.length ? stationMin[index] : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 font-semibold text-slate-700">工程 ${index + 1}</td>
                    <td class="px-3 py-2">${avg.toFixed(2)} 個/日</td>
                    <td class="px-3 py-2">${max}</td>
                    <td class="px-3 py-2">${min}</td>
                `;

                stationSummaryBody.appendChild(row);
            });

            const downloadBtn = document.getElementById('downloadCsv');
            downloadBtn.onclick = () => {
                const csv = buildCsv(dailyLog, stations);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `goal-dice-log-day${dailyLog.length}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };
        }

        function buildCsv(dailyLog, stations) {
            const headers = ['日', '出荷', '累計出荷', '総WIP', '原材料残'];
            for (let i = 0; i < stations; i++) {
                headers.push(`工程${i + 1}ロール`);
            }
            for (let i = 0; i < stations; i++) {
                headers.push(`工程${i + 1}処理量`);
            }

            const rows = [headers.join(',')];

            dailyLog.forEach(log => {
                const row = [log.day, log.shipmentToday, log.cumulativeShipment, log.totalWip, log.raw];
                row.push(...log.rolls);
                row.push(...log.processed);
                rows.push(row.join(','));
            });

            return rows.join('\n');
        }

        document.getElementById('runSimulation').addEventListener('click', () => {
            const stations = Number(document.getElementById('stations').value);
            const days = Number(document.getElementById('days').value);
            const dieSides = Number(document.getElementById('dieSides').value);
            const initialBuffer = Number(document.getElementById('initialBuffer').value);
            const rawStock = Number(document.getElementById('rawStock').value);
            const target = Number(document.getElementById('target').value);
            const seed = document.getElementById('seed').value;

            if (rawStock <= 0) {
                alert('原材料在庫は1以上で入力してください');
                return;
            }

            const result = simulate({ stations, days, dieSides, initialBuffer, rawStock, target, seed });
            renderResults(result, stations);
        });
    </script>
</body>
</html>
